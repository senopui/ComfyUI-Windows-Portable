name: "Test Build (No Upload)"

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
        - uses: actions/checkout@v6

        - name: Stage 1 Gathering Dependencies
          shell: bash
          working-directory: builder
          run: bash stage1.sh

        - name: Stage 2 Assembling Repositories
          shell: bash
          working-directory: builder
          run: bash stage2.sh

        - name: Validate workflow nodes
          shell: pwsh
          run: |
            $py = Join-Path $Env:GITHUB_WORKSPACE "builder" "ComfyUI_Windows_portable" "python_standalone" "python.exe"
            if (-not (Test-Path $py)) {
              throw "python_standalone not found at $py"
            }
            & $py (Join-Path $Env:GITHUB_WORKSPACE "scripts" "qa_validate_workflow.py")

        - name: Run Windows CPU smoke test
          shell: pwsh
          run: |
            Set-Location $Env:GITHUB_WORKSPACE
            ./scripts/qa_smoketest_windows.ps1
