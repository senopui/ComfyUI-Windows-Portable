name: "Test Build (No Upload)"

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
        - uses: actions/checkout@v6

        - name: Stage 1 Gathering Dependencies
          shell: bash
          working-directory: builder
          run: bash stage1.sh

        - name: Stage 2 Assembling Repositories
          shell: bash
          working-directory: builder
          run: bash stage2.sh

        - name: Verify portable artifact layout
          shell: pwsh
          working-directory: builder
          run: |
            Set-ExecutionPolicy Bypass -Scope Process -Force
            # $PWD is a PowerShell automatic variable that resolves to the current working directory.
            # Using $PWD here is appropriate because we're in a pwsh shell with a known working-directory
            # set by the workflow step, ensuring the path is resolved correctly within the PowerShell context.
            ../scripts/qa_verify_portable_layout.ps1 -PortableRoot "$PWD/ComfyUI_Windows_portable"

        - name: QA CPU Smoke Test (portable layout)
          shell: pwsh
          working-directory: builder
          run: |
            Set-ExecutionPolicy Bypass -Scope Process -Force
            ../scripts/qa_smoketest_windows.ps1 -PortableRoot "$PWD/ComfyUI_Windows_portable"

        - name: Validate minimal workflow fixture
          shell: bash
          working-directory: builder
          run: |
            ./ComfyUI_Windows_portable/python_standalone/python.exe -s ../scripts/qa_validate_workflow.py \
              --workflow ../tests/workflows/minimal_text2img.json \
              --comfyui-root ./ComfyUI_Windows_portable/ComfyUI
