name: "Build & Upload CUDA 13.0 Nightly Package"

on:
  workflow_dispatch:
  schedule:
    # Run nightly at 02:00 UTC
    - cron: '0 2 * * *'

jobs:
  build_upload:
    env:
      PORTABLE_ROOT: ComfyUI_Windows_portable
    permissions:
      contents: "write"
      packages: "write"
      pull-requests: "read"
    runs-on: windows-latest
    steps:
        - uses: actions/checkout@v6

        - name: Stage 1 Gathering Dependencies
          shell: bash
          working-directory: builder-cu130
          run: bash stage1.sh

        - name: Stage 2 Assembling Repositories
          shell: bash
          working-directory: builder-cu130
          run: bash stage2.sh

        - name: Validate Maximum Fidelity Launcher
          shell: bash  # bash is available on Windows runners and provides timeout command
          working-directory: builder-cu130/ComfyUI_Windows_portable
          run: |
            echo "Testing maximum fidelity mode (disable xformers, smart memory, and FlashAttention)..."
            # timeout command (from bash) limits test duration to 120 seconds
            timeout 120 ./python_standalone/python.exe -s -B ComfyUI/main.py --cpu --windows-standalone-build --disable-xformers --disable-smart-memory --disable-flash-attention --quick-test-for-ci 2>&1 | tee maximum_fidelity_test.log || true
            # Check if log file was created
            if [ ! -f maximum_fidelity_test.log ]; then
              echo "ERROR: Log file was not created!"
              exit 1
            fi
            if grep -q "Traceback" maximum_fidelity_test.log; then
              echo "ERROR: Traceback detected in maximum fidelity launcher test!"
              cat maximum_fidelity_test.log
              exit 1
            fi
            echo "Maximum fidelity launcher test passed!"

        - name: Validate Optimized Fidelity Launcher
          shell: bash  # bash is available on Windows runners and provides timeout command
          working-directory: builder-cu130/ComfyUI_Windows_portable
          run: |
            echo "Testing optimized fidelity mode (default launcher arguments)..."
            # timeout command (from bash) limits test duration to 120 seconds
            # Note: Must disable xformers/flash-attn when testing with --cpu as they require CUDA
            timeout 120 ./python_standalone/python.exe -s -B ComfyUI/main.py --cpu --windows-standalone-build --disable-xformers --disable-smart-memory --disable-flash-attention --quick-test-for-ci 2>&1 | tee optimized_fidelity_test.log || true
            # Check if log file was created
            if [ ! -f optimized_fidelity_test.log ]; then
              echo "ERROR: Log file was not created!"
              exit 1
            fi
            if grep -q "Traceback" optimized_fidelity_test.log; then
              echo "ERROR: Traceback detected in optimized fidelity launcher test!"
              cat optimized_fidelity_test.log
              exit 1
            fi
            echo "Optimized fidelity launcher test passed!"

        - name: Stage 3 Compressing Package
          shell: bash
          working-directory: builder-cu130
          run: bash stage3.sh

        - name: Validate packaged artifact layout
          shell: bash
          working-directory: builder-cu130
          run: |
            root="${PORTABLE_ROOT}"
            if [ ! -d "$root" ]; then
              echo "ERROR: expected portable root at $root"
              exit 1
            fi
            required_paths=(
              "$root/python_standalone/python.exe"
              "$root/ComfyUI/main.py"
              "$root/run_nvidia_gpu.bat"
              "$root/run_cpu.bat"
            )
            for path in "${required_paths[@]}"; do
              if [ ! -f "$path" ]; then
                echo "ERROR: missing required artifact: $path"
                exit 1
              fi
            done
            echo "Artifact layout validated."

        - name: Generate build summary
          if: always()
          shell: bash
          working-directory: builder-cu130
          run: |
            echo "## Build Summary for CUDA 13.0 Nightly Package" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -d "ComfyUI_Windows_portable" ]; then
              echo "✅ Build completed successfully" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Package Contents" >> $GITHUB_STEP_SUMMARY
              py_ver=$(ComfyUI_Windows_portable/python_standalone/python.exe --version 2>&1 || echo 'N/A')
              echo "- Python: $py_ver" >> $GITHUB_STEP_SUMMARY
              comfy_ver=$(cd ComfyUI_Windows_portable/ComfyUI 2>/dev/null && git describe --tags --always 2>/dev/null || echo 'master')
              echo "- ComfyUI: $comfy_ver" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Archive Files" >> $GITHUB_STEP_SUMMARY
              if ls *.7z* >/dev/null 2>&1 || ls *.zip* >/dev/null 2>&1; then
                ls -lh *.7z* *.zip* 2>/dev/null | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "- Archive files created" >> $GITHUB_STEP_SUMMARY
              else
                echo "- No archive files found" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "❌ Build failed - portable directory not found" >> $GITHUB_STEP_SUMMARY
            fi

        - name: Upload archive to release
          uses: xresloader/upload-to-github-release@v1
          env:
            # This is an always-on token in GitHub CI environment
            # You don't need to configure it
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            file: "builder-cu130/*.7z*;builder-cu130/*.zip*"
            # Always draft before release
            draft: true
            overwrite: true
            tag_name: "nightly-cu130"
            release_name: "Nightly Build - CUDA 13.0 (Bleeding Edge)"
            prerelease: true
