name: "Build & Upload CUDA 13.0 Nightly Package"

on:
  workflow_dispatch:
  schedule:
    # Run nightly at 02:00 UTC
    - cron: '0 2 * * *'

jobs:
  build_upload:
    env:
      PORTABLE_ROOT: ComfyUI_Windows_portable
      PORTABLE_ARCHIVE_BASENAME: ComfyUI_Windows_portable_cu130_nightly
    permissions:
      contents: "write"
      packages: "write"
      pull-requests: "read"
    runs-on: windows-latest
    steps:
        - uses: actions/checkout@v6

        - name: Resolve latest Python 3.13 standalone build
          shell: pwsh
          run: |
            $pinnedUrl = "https://github.com/astral-sh/python-build-standalone/releases/download/20251217/cpython-3.13.11%2B20251217-x86_64-pc-windows-msvc-install_only.tar.gz"
            $pinnedSha = "1fc6f07e075da66babb806802db8c86eecf1e9d29cbcb7f00227a87947b3735a"
            ./builder-cu130/scripts/resolve_python.ps1 -PinnedUrl $pinnedUrl -PinnedSha256 $pinnedSha
            Write-Host "Resolved Python URL: $env:PYTHON_STANDALONE_URL"
            Write-Host "Resolved Python SHA256: $env:PYTHON_STANDALONE_SHA256"

        - name: Stage 1 Gathering Dependencies
          shell: bash
          working-directory: builder-cu130
          env:
            SKIP_CORE_ATTENTION: "1"
            SKIP_SPARGEATTN: "1"
          run: bash stage1.sh

        - name: Install core attention stack (manifested)
          shell: pwsh
          working-directory: builder-cu130
          run: ./scripts/install_core_attention.ps1

        - name: Nightly core attention diagnostics
          shell: pwsh
          working-directory: builder-cu130
          run: |
            python --version
            python -c "import torch; print(torch.__version__, torch.version.cuda)"
            python -c "try: import flash_attn; print('flash_attn import: OK')\nexcept Exception as exc: print(f'WARNING: flash_attn import failed: {exc.__class__.__name__}: {exc}')"

        - name: Install optional accelerators (best effort)
          shell: pwsh
          working-directory: builder-cu130
          env:
            SPARGEATTN_NIGHTLY: "1"
          run: ./scripts/install_optional_accel.ps1

        - name: Accelerator manifest summary
          shell: pwsh
          working-directory: builder-cu130
          run: |
            $manifest = "accel_manifest.json"
            if (-not (Test-Path $manifest)) {
              throw "Missing $manifest"
            }
            $data = Get-Content $manifest | ConvertFrom-Json
            Write-Host "=== Accelerator install summary ==="
            $data | Select-Object name, version, source, success | Format-Table -AutoSize

        - name: Upload accelerator manifest
          uses: actions/upload-artifact@v4
          with:
            name: accel-manifest
            path: builder-cu130/accel_manifest.json

        - name: Attempt xformers install (best effort)
          shell: pwsh
          working-directory: builder-cu130
          run: ./scripts/attempt_install_xformers.ps1

        - name: Stage 2 Assembling Repositories
          shell: bash
          working-directory: builder-cu130
          run: bash stage2.sh

        - name: Pre-packaging sanity check
          shell: bash
          working-directory: builder-cu130
          run: |
            echo "=== Verifying packaged artifact structure before compression ==="
            root="ComfyUI_Windows_portable"
            if [ ! -d "$root" ]; then
              echo "ERROR: Portable root directory not found at $root"
              exit 1
            fi
            echo ""
            echo "=== Top-level files in $root ==="
            ls -lah "$root"/*.bat "$root"/*.py 2>/dev/null || echo "(No .bat or .py files found in root)"
            echo ""
            echo "=== Checking required launcher files ==="
            required_launchers=(
              "$root/run_nvidia_gpu.bat"
              "$root/run_cpu.bat"
            )
            missing_launchers=0
            for launcher in "${required_launchers[@]}"; do
              if [ -f "$launcher" ]; then
                echo "[OK] Found: $launcher"
              else
                echo "[MISSING] $launcher"
                missing_launchers=$((missing_launchers + 1))
              fi
            done
            if [ $missing_launchers -gt 0 ]; then
              echo ""
              echo "ERROR: $missing_launchers required launcher(s) missing!"
              exit 1
            fi
            echo ""
            echo "=== Pre-packaging sanity check PASSED ==="

        - name: Stage 3 Compressing Package
          shell: bash
          working-directory: builder-cu130
          run: bash stage3.sh

        - name: Validate packaged artifact layout
          shell: bash
          working-directory: builder-cu130
          run: |
            root="${PORTABLE_ROOT}"
            if [ ! -d "$root" ]; then
              echo "ERROR: expected portable root at $root"
              exit 1
            fi
            required_paths=(
              "$root/python_standalone/python.exe"
              "$root/ComfyUI/main.py"
              "$root/run_nvidia_gpu.bat"
              "$root/run_cpu.bat"
            )
            for path in "${required_paths[@]}"; do
              if [ ! -f "$path" ]; then
                echo "ERROR: missing required artifact: $path"
                exit 1
              fi
            done
            echo "Artifact layout validated."

        - name: Generate build summary
          if: always()
          shell: bash
          working-directory: builder-cu130
          run: |
            echo "## Build Summary for CUDA 13.0 Nightly Package" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -d "ComfyUI_Windows_portable" ]; then
              echo "✅ Build completed successfully" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Package Contents" >> $GITHUB_STEP_SUMMARY
              py_ver=$(ComfyUI_Windows_portable/python_standalone/python.exe --version 2>&1 || echo 'N/A')
              echo "- Python: $py_ver" >> $GITHUB_STEP_SUMMARY
              comfy_ver=$(cd ComfyUI_Windows_portable/ComfyUI 2>/dev/null && git describe --tags --always 2>/dev/null || echo 'master')
              echo "- ComfyUI: $comfy_ver" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Archive Files" >> $GITHUB_STEP_SUMMARY
              shopt -s nullglob
              archives=( "${PORTABLE_ARCHIVE_BASENAME}.7z"* "${PORTABLE_ARCHIVE_BASENAME}.zip"* "models.zip"* )
              if [ ${#archives[@]} -gt 0 ]; then
                ls -lh "${archives[@]}" 2>/dev/null | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "- Archive files created" >> $GITHUB_STEP_SUMMARY
              else
                echo "- No archive files found" >> $GITHUB_STEP_SUMMARY
              fi
              shopt -u nullglob
            else
              echo "❌ Build failed - portable directory not found" >> $GITHUB_STEP_SUMMARY
            fi

        - name: Upload archive to release
          uses: xresloader/upload-to-github-release@v1
          env:
            # This is an always-on token in GitHub CI environment
            # You don't need to configure it
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            file: "builder-cu130/${{ env.PORTABLE_ARCHIVE_BASENAME }}.7z*;builder-cu130/${{ env.PORTABLE_ARCHIVE_BASENAME }}.zip*;builder-cu130/models.zip*"
            # Always draft before release
            draft: true
            overwrite: true
            tag_name: "nightly-cu130"
            release_name: "Nightly Build - CUDA 13.0 (Bleeding Edge)"
            prerelease: true
